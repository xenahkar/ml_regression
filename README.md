#  Предсказание стоимости автомобилей с помощью регрессии

## Что было сделано и с какими результатами
### Разведочный анализ данных и предобработка данных
- Рассчитаны основные статистики как по числовым, так и по категориальным столбцам.
- Удалены объекты в трейне с одинаковым признаковым описанием (повторения).
- Преобразованы в трейне и тесте признаки mileage, engine, max_power из строк в float (удаление единиц измерения).
- Удалены в трейне и тесте признаки torque, name.
- Заполнены пропуски в столбцах mileage, engine, max_power,seats медианами из трейна.
- Преобразованы столбцы engine и seats  в int.
### Визуализация данных
- Построены графики попарных распределений числовых признаков трейна и теста.
- Установлены зависимости признаков с целевой переменной:
  - Стоимость растет при увеличении года выпуска машины: новые машины дороже старых, при этом среди свежих машин встречаются как дешевые, так и дорогие.

  - Стоимость снижается в зависимости от пробега: чем меньше пробег, тем дороже стоит машина, при этом бывают машины с маленьким пробегом и низкой стоимостью.

  - Стоимость растет с увеличением мощности.

- Построена тепловая карта попарных корреляций между числовыми признаками.
- Определены наименее и наиболее скоррелированные признаки:
  - Наименьшая корреляция между объемом двигателя engine и годом выпуска year.
  - Наибольшая корреляция между стоимостью (selling_price) и мощностью автомобиля (max_power), между объемом двигателя (engine) и мощностью (max_power), между объемом двигателя (engine) и количеством (seats).
- Построена диаграмма рассеяния для наиболее скоррелированной пары признаков.
- Построены распределения плотности вероятности по числовым признакам на трейне и тесте.

### Обучение моделей

*Модели на вещественных признаках:*

 - Линейная регрессия с дефолтными параметрами: $MSE$ = 233298779730, $R^2$ = 0.5941
 - Линейная регрессия с нормализованными признаками с дефолтными параметрами: $MSE$ = 233298779730, $R^2$ = 0.5941
 - L1-регрессия с нормализованными признаками с дефолтными параметрами: $MSE$ = 233299450599, $R^2$ = 0.5941

Далее осуществлен подбор оптимальных параметров перебором по сетке (c 10-ю фолдами) с помощью GridSearchCV.

 - L1-регрессия с нормализованными признаками ('alpha': 10000.0): $MSE$ = 244847867401, $R^2$ = 0.5741
 - ElasticNet-регрессия с нормализованными признаками ('alpha': 1.0, 'l1_ratio': 0.9): $MSE$ = 254879256612, $R^2$ = 0.5566
   
*Модель на вещественных и категориальных признаках:*

OneHot-кодированием были закодированы категориальные фичи ('fuel', 'seller_type', 'transmission', 'owner') и количество мест в машине ('seats'). Подбор оптимальных параметров осуществлялся перебором по сетке (c 10-ю фолдами) с помощью GridSearchCV.
  - L2-регрессия ('alpha': 1.0): $MSE$ = 203677821138, $R^2$ = 0.6457

Добавление в модель категориальных признаков, закодированных с помощью OneHot-кодирования, дало прирост в качестве по $MSE$ и $R^2$ по сравнению с моделями, построенными только на вещественных признаках.

### Feature engineering
**Новые признаки на основе уже существующих**. Добавлены полиномы 2 степени с помощью PolynomialFeatures.

*Модель на вещественных признаках:*
  - L1-регрессия с полиномами 2 степени и нормализованными признаками ('alpha': 10000.0): $MSE$ = 171253209212, $R^2$ = 0.7021
  - L2-регрессия с полиномами 2 степени и нормализованными признаками ('alpha': 0.001): $MSE$ = 100413337528, $R^2$ = 0.8253
    
*Модель на вещественных и категориальных признаках:*
  
- L2-регрессия с полиномами 2 степени и нормализованными признаками ('alpha': 0.001): $MSE$ = 103329547387, $R^2$ = 0.8202

Добавление в модель с вещественными признаками полиномов 2 степени дало прирост в качестве по по $MSE$ и $R^2$, при этом добавление категориальных признаков не улучшило метрики.

**Работа с выбросами**. Построены boxplot для каждого параметра на трейне и произведена очистка от выбросов.

*Модель на вещественных признаках:*

- L1-регрессия  с полиномами 2 степени и нормализованными признаками ('alpha': 1000.0): $MSE$ = 134001823619, $R^2$ = 0.7669
- L2-регрессия с полиномами 2 степени и нормализованными признаками ('alpha': 0.001): $MSE$ = 97937104965, $R^2$ = 0.8296

### Часть Бизнесовая
- Оценена бизнес метрика на тестовой выборке (доля предиктов, отличающихся от реальных цен на эти авто не более чем на 10% (в одну или другую сторону)):  0.298
  

### Сервис на FastApi

Сохранена лучшая модель в pickle файл с весами, коэффициентами скейлинга и объектами для создания полиномов.

Реализованы методы:
- predict_item: метод post, который получает на вход один объект класса, на выходе сервис выдает предсказанную стоимость машины
- predict_items: метод post, который получает на вход коллекцию объектов класса, на выходе сервис выдает список предсказанных стоимостей машин
 
## Что дало наибольший буст в качестве

Использование L2-регрессии после очистки трейна от выбросов и добавления полиномов к вещественным признакам поспособствовало наибольшему бусту в качестве: удалось достичь $R^2$ = 0.8296 на тесте.

## Что сделать не вышло и почему

Можно было бы еще поработать с признаками (feature engineering). Например: заменять пропуски, а не просто удалять машину; спарсить дополнительную информацию по маркам автомобилей и вместо удаления столбца с названием ('name') добавить класс автомобиля.  По причине отсутствия свободного времени эти эксперименты не удалось реализовать.


## Пример работы сервиса

### /predict_item

<img width="800" alt="Снимок экрана 2023-11-28 в 21 36 10" src="https://github.com/xenahkar/ml_regression/assets/144525678/657eee65-bff5-49b9-9da0-433d47f5abf9">

### /predict_items

<img width="800" alt="Снимок экрана 2023-11-28 в 21 35 17" src="https://github.com/xenahkar/ml_regression/assets/144525678/f893a15a-a313-4639-a300-c402709b4b04">


